---
title: "W203 Lab 2"
author: "w203 team 1: Kisha Kim, Patricia Gallagher, Sean Koval, Eric Ellestad"
subtitle: 'w203: Lab 2 Pumpkin and weather impact'

output:
  pdf_document: default
  html_document: default
---

```{r load packages, message = FALSE}
library(tidyverse)
library(ggplot2) 
library(sandwich)
library(stargazer)
library(lmtest)
library(dplyr)
library(readr)
library(car)
library(moments)
library(jtools)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
#source('./src/load_and_clean.R')
#source('./src/get_robust_se.R')
```

```{r load data} 
d_pumpkin <- read.csv("pumpkin_consol.csv")
```

```{r conduct EDA in this chunk for pumpkin data}
summary(d_pumpkin$weight_lbs)
plot1 <- d_pumpkin %>%
  ggplot(aes(x=weight_lbs)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of Pumpkin Weight")
print(plot1)

summary(d_pumpkin$est_weight)
plot2 <- d_pumpkin %>%
  ggplot(aes(x=est_weight)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of Estimated Weight")
print(plot2)

summary(d_pumpkin$ott)
plot3 <- d_pumpkin %>%
  ggplot(aes(x=ott)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of Over the top inches")
print(plot3)




```
```{r conduct EDA in this chunk for weather data}
summary(d_pumpkin$rain_daily_avg)
plot11 <- d_pumpkin %>%
  ggplot(aes(x=rain_daily_avg)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of daily avg rain")
print(plot11)

summary(d_pumpkin$TMIN)
plot12 <- d_pumpkin %>%
  ggplot(aes(x=TMIN)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of min temperature")
print(plot12)

summary(d_pumpkin$TMAX)
plot13 <- d_pumpkin %>%
  ggplot(aes(x=TMAX)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of max temperature")
print(plot13)




```


```{r fit a regression model here}
model1 <- lm(weight_lbs ~ rain_total+rain_daily_avg+TMIN+TMAX+factor(year) , data=d_pumpkin)
model2 <- lm(weight_lbs ~ rain_total+rain_daily_avg+TMIN+TMAX+factor(year)+rain_daily_stdev , data=d_pumpkin)
model3 <- lm(weight_lbs ~ rain_total+rain_daily_avg+TMIN+TMAX+factor(year) +rain_daily_stdev +est_weight, data=d_pumpkin)

stargazer(
   model1, 
   type = 'text', 
   se = list(get_robust_se(model1))
   )

stargazer(
   model2, 
   type = 'text', 
   se = list(get_robust_se(model2))
   )

stargazer(
   model3, 
   type = 'text', 
   se = list(get_robust_se(model3))
   )


```

``` {r}
coeftest(model1, vcov=vcovHC(model1))
coeftest(model2, vcov=vcovHC(model2))
coeftest(model3, vcov=vcovHC(model3))
```




```{r code }
# model 1
model1_preds <- predict(model1)
model1_resids <- resid(model1)
# model 2
model2_preds <- predict(model2)
model2_resids <- resid(model2)
# model 3
model3_preds <- predict(model3)
model3_resids <- resid(model3)

plot1 <- ggplot(data=d_pumpkin, aes(model1_preds, model1_resids)) + geom_point() +
stat_smooth()
print(plot1)

plot2 <- ggplot(data=d_pumpkin, aes(model2_preds, model2_resids)) + geom_point() +
stat_smooth()
print(plot2)

# TODO: this had an error when running.
#plot3 <- ggplot(data=d_pumpkin, aes(model3_preds, model3_resids)) + geom_point() +
#stat_smooth()
#print(plot3)
```


```{r code and plots assessing normally distributed errors}
plot(model1$residuals)
plot(model2$residuals)
plot(model3$residuals)
# model 1
hist(residuals(model1))
boxplot(residuals(model1)) 
jarque.test(model1$residuals)
# model 2
hist(residuals(model2))
boxplot(residuals(model2)) 
jarque.test(model2$residuals)
# model 3
hist(residuals(model3))
boxplot(residuals(model3)) 
jarque.test(model3$residuals)
```

```{r code plotting residuals}
plot_errors_1 <- d_pumpkin %>% 
  ggplot(aes(x=model1_resids)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of Residuals Model1")
print(plot_errors_1)

plot_errors_2 <- d_pumpkin %>% 
  ggplot(aes(x=model2_resids)) + 
  geom_histogram(bins=100) + 
  ggtitle("Distribution of Residuals Model2")
print(plot_errors_2)
# TODO: Same error as aboe 'aesthetics must be either length 1 or the same...'
#plot_errors_3 <- d_pumpkin %>% 
#  ggplot(aes(x=model3_resids)) + 
#  geom_histogram(bins=100) + 
#  ggtitle("Distribution of Residuals Model3")
#print(plot_errors_3)

qqplot_1 <- d_pumpkin %>% 
  ggplot(aes(sample=model1_resids)) + 
  stat_qq() + stat_qq_line() +
  ggtitle("QQPlot of Residuals Model1")
print(qqplot_1)

qqplot_2 <- d_pumpkin %>% 
  ggplot(aes(sample=model2_resids)) + 
  stat_qq() + stat_qq_line() +
  ggtitle("QQPlot of Residuals Model2")
print(qqplot_2)
# TODO: Same error as the above for model 3
#qqplot_3 <- d_pumpkin %>% 
#  ggplot(aes(sample=model3_resids)) + 
#  stat_qq() + stat_qq_line() +
#  ggtitle("QQPlot of Residuals Model3")
#print(qqplot_3)
```

```{r code comparing models}
# model 1 vs model 2
anova(model1, model2)
# model 2 vs model 3 - model 2 and 3 were not fitted on the same sized dataset
#anova(model2,model3)
# Same error as above
# model 1 vs model 3
# anova(model1, model3)
# There are aliased variables (causing error) meaning they are perfectly linear dependent on others. Need to find what those are
#waldtest(model1, model2, model3)
```
```{r code to find those aliased variables}
# looks like the relationship to rain total?
alias(model1)
```